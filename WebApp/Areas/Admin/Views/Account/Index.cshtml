@{
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}
<style>
    .hidden {
        display: none !important;
    }

    .flex-shrink-0{
        height: 60px;
    }
    /* Căn chỉnh toàn bảng */
    #listCompany {
        margin-top: 0 !important; /* Giảm lề trên */
        padding-top: 0 !important;
        border-collapse: collapse; /* Gộp đường viền cho gọn */
        font-size: 14px; /* Cỡ chữ hợp lý */
        line-height: 1.4; /* Giảm chiều cao dòng */
    }

        /* Đảm bảo mỗi ô có độ rộng hợp lý và sát nhau hơn */
        #listCompany th, #listCompany td {
            padding: 4px 8px; /* Ít padding hơn */
            text-align: left;
            vertical-align: middle; /* Căn giữa theo chiều dọc */
            border: 1px solid #e3e3e3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            word-wrap: break-word; /* Cho phép bẻ dòng trong các ô dài mà không bị tràn */
        }
        /* Cải thiện giao diện bảng khi có nội dung dài */
        #listCompany tbody tr {
            word-wrap: break-word; /* Cho phép bẻ dòng trong các ô dài */
        }

            #listCompany tbody tr:hover {
                background-color: #f9f9f9;
                cursor: pointer;
            }
        /* Giảm khoảng cách giữa dòng tiêu đề và các hàng dữ liệu */
        #listCompany th {
            padding-top: 3px; /* Giảm khoảng cách trên tiêu đề */
            padding-bottom: 3px; /* Giảm khoảng cách dưới tiêu đề */
            text-align: center; /* Căn giữa văn bản tiêu đề */
            background-color: #f1f1f1; /* Đặt màu nền cho tiêu đề */
            font-weight: bold; /* Làm đậm các tiêu đề */
        }

        /* Các phần tử trong bảng có thể điều chỉnh theo nhu cầu */
        #listCompany td {
            font-size: 14px;
        }

        /* Thêm hiệu ứng hover cho các hàng trong bảng */
        #listCompany tbody tr:hover {
            background-color: #e7e7e7;
            cursor: pointer;
        }

        /* Đảm bảo không bị tràn khi có văn bản dài */
        #listCompany td {
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }

    .card-body {
        padding-top: 5px;
    }
    .switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 30px;
    }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 30px;
    }

        .slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

    input:checked + .slider {
        background-color: #4CAF50;
    }

        input:checked + .slider:before {
            transform: translateX(30px);
        }

    /* Thêm chữ ON / OFF */
    .toggle-text {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        font-size: 13px;
        font-weight: bold;
        color: white;
        transition: 0.4s;
    }

        /* Chữ ON bên trái, OFF bên phải */
        .toggle-text.on {
            left: 10px;
        }

        .toggle-text.off {
            right: 10px;
        }

    /* Khi OFF: Hiển thị OFF, ẩn ON */
    input:not(:checked) + .slider .toggle-text.on {
        display: none;
    }

    /* Khi ON: Hiển thị ON, ẩn OFF */
    input:checked + .slider .toggle-text.off {
        display: none;
    }

    .p-3 {
        padding-left: 1rem !important;
        padding-right: 1rem !important;
        padding-top: 0px;
       
    }
</style>
<body>
    <div id="companyListContainer" class="container-fluid d-flex flex-column vh-100">
        <!-- Mục lọc -->
        <div class="row flex-shrink-0">
            <div class="col-12">
                <div class="card p-2">
                    <form class="d-flex align-items-center w-100" style="gap: 10px;">
                        <input type="text" class="form-control form-control-sm w-25" style="min-width: 170px; padding: 5px;" placeholder="Mã khách hàng/Tên công ty/MST/Tài khoản root">
                        <select class="form-select form-select-sm" style="padding: 5px;">
                            <option selected>Tất cả</option>
                            <option>Vip</option>
                            <option>Bình thường</option>
                        </select>

                        <button id="searchBtn" class="btn btn-primary btn-sm flex-grow-1 px-3" style="padding: 5px; margin-right: 10px;">🔍 Tìm kiếm</button>
                        <button class="btn btn-warning btn-sm flex-grow-1 px-3" style="padding: 5px; margin-right: 10px;" onclick=" exportToCsv(event)">📥 Xuất Excel</button>
                        <button class="btn btn-success btn-sm flex-grow-1 px-3" style="padding: 5px; margin-right: 10px;" onclick="refresh()">➕ Làm mới</button>
                        <button id="createAccountBtn" class="btn btn-danger btn-sm flex-grow-1 px-3" style="padding: 5px;">👤 Tạo tài khoản</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Mục hiển thị danh sách -->
        <div class="row flex-grow-1 overflow-auto">
            <div class="col-12">
                <div class="card p-3 h-100">
                    <div class="table-responsive h-100">
                        <table id="listCompany" class="table table-striped table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>STT</th>
                                    <th>Mã khách hàng</th>
                                    <th>Tên công ty</th>
                                    <th>Mã số thuế</th>
                                    <th>Tài khoản root</th>
                                    <th>Ngày cấp tài khoản</th>
                                    <th>Trạng thái</th>
                                    <th>Update</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Thêm các dòng khác tương tự -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="createAccountContainer" class="container-fluid d-flex flex-column vh-100" style="display: none;">
        <div class="row flex-shrink-0" >
            <div class="col-12">
                <div class="card p-2">
                    <form class="d-flex align-items-center w-100" style="gap: 10px;">
                       
                        <button id="backBtn" class="btn btn-secondary btn-sm px-3">
                            🔙 Quay lại
                        </button>
                    </form>

                </div>
            </div>
        </div>

        <div class="row flex-grow-1 overflow-auto">
            <!-- Form bên trái -->
            <div class="col-md-6">
                <div class="card-body">
                    <h5>THÔNG TIN CÔNG TY</h5>
                    <form>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Tên công ty: <span class="text-danger">*</span></label>
                            <input type="text" class="form-control w-75" id="cName">
                        </div>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Mã khách hàng:</label>
                            <input type="text" class="form-control w-75" id="cId" readonly>
                        </div>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Mã số thuế: <span class="text-danger">*</span></label>
                            <input type="text" class="form-control w-75" id="cTaxCode">
                        </div>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Email: <span class="text-danger">*</span></label>
                            <input type="email" class="form-control w-75" id="cEmail" pattern="@(@"[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}")" required>
                        </div>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Số điện thoại: <span class="text-danger">*</span></label>
                            <input type="text" class="form-control w-75 phone-input" id="cPhone" maxlength="10">
                        </div>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Địa chỉ: <span class="text-danger">*</span></label>
                            <input type="text" class="form-control w-75" id="cAddress">
                        </div>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Phân loại:</label>
                            <select class="form-control w-75" id="cType" name="cType">
                                <option value="normal">Bình thường</option>
                                <option value="vip">VIP</option>
                            </select>
                        </div>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Số hợp đồng: <span class="text-danger">*</span></label>
                            <input type="text" class="form-control w-75" id="ContractNumber" readonly>
                        </div>
                       @*  <div class="form-group d-flex align-items-center">
                            <label class="w-25">Loại dịch vụ:</label>
                            <select class="form-control w-75" id="serviceType">
                                <option value="dau-so-thoai">Đầu số thoại</option>
                                <option value="an-toan-thong-tin">An toàn thông tin</option>
                                <option value="cloud-partner">Cloud partner</option>
                                <option value="dich-vu-dien-tu">Dịch vụ điện tử</option>
                                <option value="dich-vu-phan-mem">Dịch vụ phần mềm (SaaS)</option>
                                <option value="dien-toan-dam-may">Điện toán đám mây</option>
                                <option value="giam-sat">Giám sát</option>
                                <option value="trung-tam-du-lieu">Trung tâm dữ liệu</option>
                                <option value="thiet-bi">Thiết bị</option>
                                <option value="hoi-nghi-truyen-hinh">Hội nghị truyền hình</option>
                                <option value="kenh-truyen">Kênh truyền</option>
                                <option value="tin-nhan">Tin nhắn</option>
                                <option value="tong-dai">Tổng đài</option>
                                <option value="ho-tro-cntt">Hỗ trợ CNTT</option>
                                <option value="hop-dong-tich-hop">Hợp đồng tích hợp/dự án</option>
                                <option value="hop-dong-hop-tac">Hợp đồng hợp tác</option>
                                <option value="dich-vu-truyen-hinh">Dịch vụ truyền hình</option>
                                <option value="doi-tac">Đối tác</option>
                            </select>
                        </div> *@
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Loại dịch vụ:</label>
                            <select class="form-control w-75" id="serviceType">
                            </select>
                        </div>

                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Trạng thái:</label>
                            <select class="form-control w-75" id="aStatus" disabled>
                                <option value="1">Hoạt động</option>
                                <option value="0">Không hoạt động</option>
                            </select>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Form bên phải -->
            <div class="col-md-6">
                <div class="card-body">
                    <h5>THÔNG TIN TÀI KHOẢN</h5>
                    <form>
                        @* <div class="form-group d-flex align-items-center">
                            <label class="w-25">Username:</label>
                            <input type="text" class="form-control w-75" id="aNameID" readonly>
                        </div> *@
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Email: <span class="text-danger">*</span></label>
                            <input type="email" class="form-control w-75" id="aEmail">
                        </div>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Họ và tên: <span class="text-danger">*</span></label>
                            <input type="text" class="form-control w-75" id="aName">
                        </div>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Số điện thoại: <span class="text-danger">*</span></label>
                            <input type="text" class="form-control w-75 phone-input" id="aPhone" maxlength="10">
                        </div>
                        

                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Ngày sinh:</label>
                            <input type="date" class="form-control w-75" id="aDate" >
                        </div>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Giới tính:</label>
                            <select class="form-control w-75" id="aGender" name="aGender">
                                <option value="nam">Nam</option>
                                <option value="nu">Nữ</option>
                            </select>
                        </div>

                         <div class="form-group d-flex align-items-center">
                            <label class="w-25">Ngày bắt đầu:</label>
                            <input type="date" class="form-control w-75" id="startDate" readonly>
                        </div>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Ngày kết thúc:</label>
                            <input type="date" class="form-control w-75" id="endDate" readonly>
                        </div>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Thời hạn hợp đồng:</label>
                            <select id="timeGiahan">
                                <option value="">Vui lòng chọn thời gian</option>
                                <option value="1month">1 tháng</option>
                                <option value="2month">2 tháng</option>
                                <option value="3month">3 tháng</option>
                                <option value="4month">4 tháng</option>
                                <option value="5month">5 tháng</option>
                                <option value="6month">6 tháng</option>
                                <option value="7month">7 tháng</option>
                                <option value="8month">8 tháng</option>
                                <option value="9month">9 tháng</option>
                                <option value="10month">10 tháng</option>
                                <option value="11month">11 tháng</option>
                                <option value="12month">12 tháng</option>
                                <option value="13month">13 tháng</option>
                                <option value="14month">14 tháng</option>
                                <option value="15month">15 tháng</option>
                                <option value="16month">16 tháng</option>
                                <option value="17month">17 tháng</option>
                                <option value="18month">18 tháng</option>
                            </select>
                        </div>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Tổng tiền:</label>
                            <input type="text" class="form-control w-75" id="amount" readonly>
                        </div> 
                    </form>
                    <button id="createAccount" class="btn btn-danger btn-sm px-3" onclick="SaveAccount()">Lưu tài khoản</button>
                </div>
            </div>
        </div>
    </div>
    <div id="updateAccountContainer" class="container-fluid d-flex flex-column vh-100" style="display: none;">
        <div class="row flex-shrink-0" >
            <div class="col-12">
                <div class="card p-2">
                    <form class="d-flex align-items-center w-100" style="gap: 10px;">

                        <button id="backBtn2" class="btn btn-secondary btn-sm px-3">
                            🔙 Quay lại
                        </button>
                    </form>

                </div>
            </div>
        </div>

        <div class="row flex-grow-1 overflow-auto">
            <!-- Form bên trái -->
            <div class="col-md-6">
                <div class="card-body">
                    <h5>THÔNG TIN CÔNG TY</h5>
                    <form>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Tên công ty: <span class="text-danger">*</span></label>
                            <input type="text" class="form-control w-75" id="cName2">
                        </div>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Mã khách hàng:</label>
                            <input type="text" class="form-control w-75" id="cId2" readonly>
                        </div>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Mã số thuế: <span class="text-danger">*</span></label>
                            <input type="text" class="form-control w-75" id="cTaxCode2">
                        </div>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Email: <span class="text-danger">*</span></label>
                            <input type="email" class="form-control w-75" id="cEmail2" pattern="@(@"[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}")" required>
                        </div>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Số điện thoại: <span class="text-danger">*</span></label>
                            <input type="text" class="form-control w-75 phone-input" id="cPhone2" maxlength="10">
                        </div>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Địa chỉ: <span class="text-danger">*</span></label>
                            <input type="text" class="form-control w-75" id="cAddress2">
                        </div>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Phân loại:</label>
                            <select class="form-control w-75" id="cType2" name="cType2" disabled>
                                <option value="normal">Bình thường</option>
                                <option value="vip">VIP</option>
                            </select>
                        </div>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Ngày tạo TK:</label>
                            <input type="date" class="form-control w-75" id="accountIssuedDate" readonly>
                        </div>
                         @* <div class="form-group d-flex align-items-center">
                            <label class="w-25">Số hợp đồng: <span class="text-danger">*</span></label>
                            <input type="text" class="form-control w-75" id="ContractNumber2" readonly>
                        </div> *@
                        @* <div class="form-group d-flex align-items-center">
                            <label class="w-25">Loại dịch vụ:</label>
                            <select id="serviceType2" disabled>
                                <option value="dau-so-thoai">Đầu số thoại</option>
                                <option value="an-toan-thong-tin">An toàn thông tin</option>
                                <option value="cloud-partner">Cloud partner</option>
                                <option value="dich-vu-dien-tu">Dịch vụ điện tử</option>
                                <option value="dich-vu-phan-mem">Dịch vụ phần mềm (SaaS)</option>
                                <option value="dien-toan-dam-may">Điện toán đám mây</option>
                                <option value="giam-sat">Giám sát</option>
                                <option value="trung-tam-du-lieu">Trung tâm dữ liệu</option>
                                <option value="thiet-bi">Thiết bị</option>
                                <option value="hoi-nghi-truyen-hinh">Hội nghị truyền hình</option>
                                <option value="kenh-truyen">Kênh truyền</option>
                                <option value="tin-nhan">Tin nhắn</option>
                                <option value="tong-dai">Tổng đài</option>
                                <option value="ho-tro-cntt">Hỗ trợ CNTT</option>
                                <option value="hop-dong-tich-hop">Hợp đồng tích hợp/dự án</option>
                                <option value="hop-dong-hop-tac">Hợp đồng hợp tác</option>
                                <option value="dich-vu-truyen-hinh">Dịch vụ truyền hình</option>
                                <option value="doi-tac">Đối tác</option>
                            </select>
                        </div> *@
                        @*<div class="form-group d-flex align-items-center">
                            <label class="w-25">Trạng thái:</label>
                            <select class="form-control w-75" id="aStatus2" disabled>
                                <option value="1">Hoạt động</option>
                                <option value="0">Không hoạt động</option>
                            </select>
                        </div> *@
                    </form>
                </div>
            </div>

            <!-- Form bên phải -->
            <div class="col-md-6">
                <div class="card-body">
                    <h5>THÔNG TIN TÀI KHOẢN</h5>
                    <form>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Username:</label>
                            <input type="text" class="form-control w-75" id="aNameID2" readonly>
                        </div>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Email: <span class="text-danger">*</span></label>
                            <input type="email" class="form-control w-75" id="aEmail2">
                        </div>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Họ và tên: <span class="text-danger">*</span></label>
                            <input type="text" class="form-control w-75" id="aName2">
                        </div>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Số điện thoại: <span class="text-danger">*</span></label>
                            <input type="text" class="form-control w-75 phone-input" id="aPhone2" maxlength="10">
                        </div>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Ngày sinh:</label>
                            <input type="date" class="form-control w-75" id="aDate2">
                        </div>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Giới tính:</label>
                            <select class="form-control w-75" id="aGender2" name="aGender2">
                                <option value="nam">Nam</option>
                                <option value="nu">Nữ</option>
                            </select>
                        </div>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Trạng thái:</label>
                            <select class="form-control w-75" id="aStatus2" disabled>
                                <option value="1">Hoạt động</option>
                                <option value="0">Không hoạt động</option>
                            </select>
                        </div>
                        
                        @* <div class="form-group d-flex align-items-center">
                            <label class="w-25">Ngày bắt đầu:</label>
                            <input type="date" class="form-control w-75" id="startDate2" readonly>
                        </div>
                        <div class="form-group d-flex align-items-center">
                            <label class="w-25">Ngày kết thúc:</label>
                            <input type="date" class="form-control w-75" id="endDate2" readonly>
                        </div> *@
                        @* <div class="form-group d-flex align-items-center">
                            <label class="w-25">Tổng tiền:</label>
                            <input type="text" class="form-control w-75" id="amount2" readonly>
                        </div> *@
                    </form>
                    <button id="createAccount" class="btn btn-danger btn-sm px-3" onclick="SaveAccount()">Lưu tài khoản</button>
                </div>
            </div>
        </div>
    </div>
</body>

<!-- Modal confirm -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="xacNhanModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="xacNhanModalLabel">Xác nhận hành động</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <span class="" id="contentModalConfirm"></span>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal"> Đóng </button>
                <button type="button" class="btn btn-primary" id="confirmButton1">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal success-->
<div class="modal fade" id="ModalSuccess" tabindex="-1" role="dialog" aria-labelledby="ModalSuccess" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body text-center bg-green">
                <span id="contentModalSuccess"></span>
            </div>
        </div>
    </div>
</div>

<!-- Modal thông báo lỗi -->
<div class="modal fade" id="ModalError" tabindex="-1" aria-labelledby="ModalErrorLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="ModalErrorLabel">Lỗi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="contentModalError"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btnCloseModal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const startDateInput = document.getElementById("startDate");
        const endDateInput = document.getElementById("endDate");
        const timeGiahanSelect = document.getElementById("timeGiahan");

        timeGiahanSelect.addEventListener("change", function () {
            const value = this.value;
            if (!value) {
                alert("Vui lòng chọn thời gian gia hạn!");
                return;
            }

            const monthsToAdd = parseInt(value.replace("month", ""));
            const today = new Date();

            // Set ngày bắt đầu = hôm nay
            const newStartDate = today;

            // Tính ngày kết thúc = hôm nay + số tháng
            const newEndDate = new Date(today);
            newEndDate.setMonth(newEndDate.getMonth() + monthsToAdd);

            // Cập nhật lên input
            startDateInput.value = formatDate(newStartDate);
            endDateInput.value = formatDate(newEndDate);
        });

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
    });

    document.querySelectorAll(".phone-input").forEach(function (input) {
        input.addEventListener("input", function (e) {
            let value = e.target.value;

            // Chỉ giữ lại số (loại bỏ ký tự không phải số)
            value = value.replace(/\D/g, "");

            // Giới hạn tối đa 10 số
            if (value.length > 10) {
                value = value.slice(0, 10);
            }

            e.target.value = value;
        });
    });

    document.getElementById("cTaxCode").addEventListener("input", function () {
        let value = this.value.replace(/[^a-zA-Z0-9]/g, ""); // Chỉ giữ lại chữ và số, loại bỏ kí tự đặc biệt

        if (value.length > 9) {
            value = value.substring(0, 9); // Giới hạn tối đa 9 kí tự
        }

        this.value = value;

        // Hiển thị viền đỏ nếu không đủ 9 kí tự
        if (value.length !== 9) {
            this.style.border = "2px solid red";
        } else {
            this.style.border = "1px solid #ced4da";
        }
    });

    document.getElementById("ContractNumber").addEventListener("input", function () {
        let value = this.value.replace(/[^a-zA-Z0-9]/g, ""); // Chỉ giữ lại chữ và số, loại bỏ kí tự đặc biệt

        if (value.length > 10) {
            value = value.substring(0, 10); // Giới hạn tối đa 10 kí tự
        }

        this.value = value;

        // Hiển thị viền đỏ nếu không đủ 9 kí tự
        if (value.length !== 10) {
            this.style.border = "2px solid red";
        } else {
            this.style.border = "1px solid #ced4da";
        }
    });

    document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM đã tải xong!");

        const companyListContainer = document.getElementById("companyListContainer");
        const createAccountContainer = document.getElementById("createAccountContainer");
        const updateAccountContainer = document.getElementById("updateAccountContainer");
        const createAccountBtn = document.getElementById("createAccountBtn");
        const backBtn = document.getElementById("backBtn");
        const backBtn2 = document.getElementById("backBtn2");

        console.log("companyListContainer:", companyListContainer);
        console.log("createAccountContainer:", createAccountContainer);
        console.log("updateAccountContainer:", createAccountContainer);

        console.log("createAccountBtn:", createAccountBtn);
        console.log("backBtn:", backBtn);

        // Ẩn form tạo tài khoản mặc định
        createAccountContainer.classList.add("hidden");
        updateAccountContainer.classList.add("hidden");
        
        // Khi click "Tạo tài khoản"
        createAccountBtn.addEventListener("click", function (event) {
            event.preventDefault(); // Ngăn chặn load lại trang nếu là <button>
            console.log("Nhấn Tạo tài khoản!");

            // Ẩn các form khác và hiển thị form tạo tài khoản
            companyListContainer.classList.add("hidden");
            createAccountContainer.classList.remove("hidden");
            updateAccountContainer.classList.add("hidden");

            $.ajax({
                url: `/admin/account/GetListServiceID`, // Thay URL này bằng URL thật trong backend
                headers: {
                    "Authorization": "Bearer " + tokenJWT  // Thêm token JWT nếu cần thiết
                },
                type: "GET",
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    console.log("Kết quả list dịch vụ dropdown", data);
                    const select = $('#serviceType'); // sửa ID cho đúng

                    select.empty().append('<option value="">-- Chọn --</option>');

                    data.listRegu.forEach(function (item) {
                        select.append(`<option value="${item.serviceGroupid}" data-price="${item.price}">${item.serviceTypeNames}</option>`);
                    });

                    select.change(function () {
                        const selectedOption = $(this).find("option:selected");
                        const price = selectedOption.data("price");
                        const totalPriceElement = $('#totalPrice');

                        if (price) {
                            totalPriceElement.text(`Tổng tiền: ${price} VNĐ`);
                        } else {
                            totalPriceElement.text('Tổng tiền: 0 VNĐ');
                        }
                    });

                },
                error: function () {
                    alert('Không lấy được danh sách loại dịch vụ!');
                }
            });


            refresh(); // Nếu có cần làm mới giao diện
        });

        // Khi click "Quay lại"
        backBtn.addEventListener("click", function (event) {
            event.preventDefault(); 
            console.log("Nhấn Quay lại!");
            companyListContainer.classList.remove("hidden");
            createAccountContainer.classList.add("hidden");
            updateAccountContainer.classList.add("hidden");

            init("", "Tất cả");
           
        });

        backBtn2.addEventListener("click", function (event) {
            event.preventDefault(); 
            console.log("Nhấn Quay lại!");
            companyListContainer.classList.remove("hidden");
            createAccountContainer.classList.add("hidden");
            updateAccountContainer.classList.add("hidden");

            init("", "Tất cả");
        });

        // Thêm sự kiện cho nút "Cập nhật"
        document.addEventListener("click", function (event) {
            if (event.target.classList.contains("update-btn")) {
                event.preventDefault();
                const customerId = event.target.getAttribute("data-id");
                console.log("Nhấn Cập nhật! Customer ID:", customerId);

                // Ẩn danh sách công ty, hiển thị form cập nhật
                companyListContainer.classList.add("hidden");
                createAccountContainer.classList.add("hidden");
                updateAccountContainer.classList.remove("hidden");

                //refresh();
            }
        });
    });

    $(document).ready(function () {

        init("", "Tất cả");
        // Khi bấm nút tìm kiếm
        $('#searchBtn').on('click', function (e) {
            e.preventDefault();

            var keyword = $('input[type="text"]').val();  // Lấy giá trị từ ô input
            var category = $('select').val(); // Lấy giá trị từ select

            // Gọi lại hàm init() với giá trị mới
            init(keyword, category);
        });

    });
    const tokenJWT = localStorage.getItem("accessToken");

    function init(keyword, category) {
        if ($.fn.DataTable.isDataTable("#listCompany")) {
            $("#listCompany").DataTable().destroy(); // Xóa DataTable cũ trước khi tạo lại
        }

        var table = $('#listCompany').DataTable({
            processing: true,
            serverSide: true,
            paging: true,
            searching: false,
            searchDelay: 400,
           // scrollY: false,
            iDisplayLength: 7,
            bLengthChange: false,
            language: {
                info: "Hiển thị _START_ đến _END_ của _TOTAL_ tài khoản",
                lengthMenu: "Hiển thị _MENU_  tài khoản",
                //search: "Tìm kiếm",
                processing: "Đang tải dữ liệu...",
                paginate: {
                    previous: "Trước",
                    next: "Tiếp theo",
                    last: "Cuối"
                }
            },

            ajax: {
                url: "/admin/account/GetAllCompany",
                type: "POST",
                headers: {
                    "Authorization": "Bearer " + tokenJWT
                },
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                beforeSend: function () {
                    // Optional: Show loading indicator
                },
                data: function (data) {
                    var listCompanyA = $("#listCompany").DataTable();
                    var settings = listCompanyA.settings();
                    var currentPageIndex = Math.ceil(settings[0]._iDisplayStart / settings[0]._iDisplayLength) + 1;

                    return JSON.stringify({
                        PageSize: 7,
                        Page: currentPageIndex,
                        Keyword: keyword, // Lấy giá trị từ input tìm kiếm
                        Category: category
                    });
                },
                dataSrc: function (res) {
                    console.log(res.listCompany);
                    return res.success && res.listCompany && res.listCompany.results ? res.listCompany.results : [];

                },
                dataFilter: function (data) {
                    var page = $.parseJSON(data);
                    if (!page.success || !page.listCompany) {
                        page.recordsTotal = 0;
                        page.recordsFiltered = 0;
                        return JSON.stringify(page);
                    }
                    page.recordsTotal = page.listCompany.rowCount || 0;
                    page.recordsFiltered = page.listCompany.rowCount || 0;
                    return JSON.stringify(page);
                },
                error: function (xhr, status, error) {
                    console.error("Lỗi khi lấy dữ liệu:", error);
                   // alert("Không thể tải danh sách công ty. Vui lòng thử lại!");
                    showError("Không thể tải danh sách công ty. Vui lòng thử lại!");

                }
            },
            columns: [
                {
                    data: null, width: "5%", render: function (data, type, row, meta) {
                        return meta.row + 1; // Hiển thị số thứ tự tự động
                    }
                },
                { data: "customerId", width: "17%" },
                { data: "companyName", width: "13%" },
                { data: "taxCode", width: "11%" },
                { data: "companyAccount", width: "15%" },
                {
                    data: "accountIssuedDate",
                    width: "19%",
                    render: function (data, type, row) {
                        if (!data) return ""; // Tránh lỗi khi dữ liệu null
                        let date = new Date(data);
                        return date.toLocaleDateString("vi-VN"); // Định dạng dd/mm/yyyy
                    }
                },
                {
                    data: "operatingStatus",
                    width: "13%",
                    render: function (data, type, row) {
                        let isChecked = data ? "checked" : "";
                        let text = data ? "ON" : "OFF";

                        return `
                    <label class="switch">
                        <input type="checkbox" class="toggle-customerType" data-id="${row.customerId}" ${isChecked}>
                             <span class="slider round">
                <span class="toggle-text on">ON</span>
                <span class="toggle-text off">OFF</span>
            </span>
                    </label>
                    `;
                    }
                },
                // {
                //     data: null,
                //     width: "20%",
                //     render: function (data, type, row) {
                //         return `<button id="BtnUpdate" class="btn btn-sm btn-primary update-btn" data-id="${row.customerId}"">Cập nhật</button>`;
                //     }
                // }
                {
                    data: null,
                    width: "10%",
                    render: function (data, type, row) {
                        return `<div class="text-center">
                        <i id="BtnUpdate" class="fa-solid fa-pen-to-square text-info update-btn"
                            style="cursor: pointer;font-size: 1.2rem;" title="Cập nhật" data-id="${row.customerId}"></i></div>`;
                    }
                }

            ],

            createdRow: function (row, data, dataIndex) {
                $(row).data("fullData", data); // Lưu toàn bộ dữ liệu vào row
            },

            columnDefs: [{
                "defaultContent": "-",
                "targets": "_all"
            }]
        });
    }
    
    function updateTongTien() {
        const timeSelect = document.getElementById("timeGiahan");
        const serviceType = document.getElementById("serviceType");
        const contractType = document.getElementById("cType");

        if (!timeSelect || !serviceType || !contractType) return;

        const selectedTimeValue = timeSelect.value;
        const selectedOption = serviceType.options[serviceType.selectedIndex];
        const unitPrice = parseFloat(selectedOption.getAttribute('data-price')) || 0;
        const unitID = selectedOption.getAttribute('value') || "";

        const selectedContractType = contractType.value; 

        if (!selectedTimeValue || !unitID) {
            document.getElementById("amount").value = "Vui lòng chọn thời gian";
            return;
        }

        const months = parseInt(selectedTimeValue.replace("month", ""));
        let total = unitPrice * months;
        if (selectedContractType === "vip") {
            total *= 1.3;
        }
        $.ajax({
            url: `/admin/contract/GetListEndow?id=${unitID}`,
            headers: {
                "Authorization": "Bearer " + tokenJWT
            },
            type: "GET",
            contentType: "application/json; charset=utf-8",
            success: function (response) {
                console.log("Ưu đãi lấy được:", response);

                let bestDiscount = 0;
                let bestDuration = -1; // để phân biệt ưu đãi null và 0 tháng

                if (Array.isArray(response.listendow) && response.listendow.length > 0) {
                    const now = new Date();
                    response.listendow.forEach(function (item) {
                        const start = new Date(item.startdate);
                        const end = new Date(item.enddate);
                        const duration = item.duration; // có thể null

                        if (now >= start && now <= end) {
                            // Nếu duration == null => hợp lệ cho mọi tháng
                            if (duration == null || months >= duration) {
                                if (
                                    duration == null || // ưu tiên duration null nếu chưa có ưu đãi nào
                                    duration > bestDuration ||
                                    (duration === bestDuration && item.discount > bestDiscount)
                                ) {
                                    bestDuration = duration ?? 0; // null thì gán 0
                                    bestDiscount = item.discount;
                                }
                            }
                        }
                    });
                }

                // Áp dụng giảm giá nếu tìm được ưu đãi phù hợp
                if (bestDiscount > 0) {
                    total = total * (1 - bestDiscount / 100);
                }

                document.getElementById("amount").value = formatMoney(total);
            },
            error: function () {
                console.error("Không lấy được ưu đãi.");
                document.getElementById("amount").value = formatMoney(total);
            }
        });
    }

    // Hàm định dạng tiền
    function formatMoney(number) {
        return number.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
    }

    // Gắn sự kiện onchange
    document.getElementById("timeGiahan").addEventListener("change", updateTongTien);
    document.getElementById("serviceType").addEventListener("change", updateTongTien);
    document.getElementById("cType").addEventListener("change", updateTongTien);

    $(document).on("change", ".toggle-customerType", function () {
        let toggleElement = $(this);
        let customerId = toggleElement.attr("data-id");
        let newStatus = toggleElement.is(":checked");
        let oldStatus = !newStatus;

        console.log("Customer ID:", customerId);
        console.log("Trạng thái gửi lên:", newStatus);

        if (!customerId) {
            console.error("CustomerID bị null hoặc undefined!");
            return;
        }

        var data = {
            status: newStatus,
            CustomerId: customerId,
        };

        // Hiển thị modal xác nhận
        document.getElementById("contentModalConfirm").innerHTML = "Bạn có chắc muốn cập nhật trạng thái không?";
        const modalConfirmEl = document.getElementById("confirmModal");
        const modalConfirm = new bootstrap.Modal(modalConfirmEl);
        modalConfirm.show();

        // Xử lý khi bấm nút xác nhận
        $("#confirmButton1").off("click").on("click", function () {
            modalConfirm.hide();

            $.ajax({
                url: "/admin/account/UpdateStatus",
                type: "PUT",
                headers: {
                    "Authorization": "Bearer " + tokenJWT
                },
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(data),
                success: function (res) {
                    if (res.success) {
                        console.log("Cập nhật thành công!");
                        let textElement = toggleElement.siblings(".slider").find(".toggle-text");
                        textElement.text(newStatus ? "ON" : "OFF");

                        toggleElement.prop("checked", newStatus);

                        document.getElementById("contentModalSuccess").innerHTML = "Cập nhật thành công!";
                        $("#ModalSuccess").modal("show");

                        var keyword = $('input[type="text"]').val();
                        var category = $('select').val();
                        init(keyword, category);
                    } else {
                        document.getElementById("contentModalSuccess").innerHTML = "Cập nhật thất bại!";
                        $("#ModalSuccess").modal("show");
                        toggleElement.prop("checked", oldStatus);
                    }
                },
                error: function () {
                    console.error("Lỗi khi gọi API.");
                    toggleElement.prop("checked", oldStatus);
                }
            });
        });

        // Nếu modal bị đóng mà KHÔNG bấm xác nhận → khôi phục toggle
        $(modalConfirmEl).off("hidden.bs.modal").on("hidden.bs.modal", function () {
            toggleElement.prop("checked", oldStatus);
        });
    });

    $("#listCompany").on("click", ".update-btn", function () {
        var rowData = $(this).closest("tr").data("fullData"); // Lấy dữ liệu từ hàng
        console.log("Click vào cập nhật tài khoản:", rowData);
        if (rowData) {
            $("#cName2").val(rowData.companyName);
            $("#cId2").val(rowData.customerId.trim());
            $("#cTaxCode2").val(rowData.taxCode);
            $("#cEmail2").val(rowData.companyAccount);
            $("#cPhone2").val(rowData.cPhoneNumber || "");
            $("#cAddress2").val(rowData.cAddress || "");
            $("#cType2").val(rowData.customerType ? "vip" : "normal");
           // $("#ContractNumber2").val(rowData.ContractNumber);

            // // Gán giá trị cho dropdown ServiceType
            // let foundValue = "doi-tac"; // Giá trị mặc định
            // $("#serviceType2 option").each(function () {
            //     if ($(this).text().trim() === rowData.serviceType.trim()) {
            //         foundValue = $(this).val();
            //         return false; // Thoát vòng lặp nếu tìm thấy
            //     }
            // });
            // $("#serviceType2").val(foundValue);

            $("#aNameID2").val(rowData.customerId.trim());
            $("#aEmail2").val(rowData.rootAccount || "");
            $("#aName2").val(rowData.rootName || "");
            $("#aPhone2").val(rowData.rPhoneNumber || "");
            $("#aStatus2").val(rowData.operatingStatus ? "1" : "0");
            $("#aDate2").val(rowData.dateOfBirth ? rowData.dateOfBirth.substring(0,10):"");
            $("#aGender2").val(rowData.gender ? "nu" : "nam");
            $("#accountIssuedDate").val(rowData.accountIssuedDate ? rowData.accountIssuedDate.substring(0, 10) : "");

           // $("#startDate2").val(rowData.startdate ? rowData.startdate.substring(0, 10) : "");
            //$("#endDate2").val(rowData.enddate ? rowData.enddate.substring(0, 10) : "");
           // $("#amount2").val(formatMoney(rowData.amount) || "");
        }
    });
    // Hàm định dạng tiền
    function formatMoney(number) {
        return number.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
    }
    
    function getID1 (cID){
        var cName = document.getElementById("cName").value;
        var cTaxCode = document.getElementById("cTaxCode").value;
        var cEmail = document.getElementById("cEmail").value;
        var cPhone = document.getElementById("cPhone").value;
        var cAddress = document.getElementById("cAddress").value;
        var cType = document.getElementById("cType").value;
        var ContractNumber = document.getElementById("ContractNumber").value.trim();
        var serviceType = document.getElementById("serviceType").value.trim();
        var aEmail = document.getElementById("aEmail").value;
        var aName = document.getElementById("aName").value;
        var aPhone = document.getElementById("aPhone").value;
        var aStatus = document.getElementById("aStatus").value;
        var aDate = document.getElementById("aDate").value;
        var aGender = document.getElementById("aGender").value;
        var startDate = document.getElementById("startDate").value;
        var endDate = document.getElementById("endDate").value;
        var amount = document.getElementById("amount").value.trim();

        var serviceTypeElement = document.getElementById("serviceType");
        var serviceTypeText = serviceTypeElement.options[serviceTypeElement.selectedIndex].text; // Lấy nội dung hiển thị
        var normalizedAmount = parseFloat(amount.replace(/[^\d]/g, ''));
        var cValues = {
            CustomerId: cID || "AUTO_GENERATED_ID",
            CompanyName: cName,
            TaxCode: cTaxCode,
            CompanyAccount: cEmail,
            AccountIssuedDate: new Date().toISOString(),
            CPhoneNumber: cPhone,
            CAddress: cAddress,
            CustomerType: cType.toLowerCase() === "vip",
            ContractNumber: ContractNumber,
            ServiceType: serviceTypeText, // Lưu tên hiển thị thay vì ID
            RootAccount: aEmail,
            RootName: aName,
            RPhoneNumber: aPhone,
            OperatingStatus: aStatus.trim() === "1",
            DateOfBirth: aDate ? new Date(aDate).toISOString() : null,
            Gender: aGender === "nu",
            Startdate: startDate,
            EndDate: endDate,
            Amount: normalizedAmount
        };
        return cValues;
    }

    function getID2 (cID){
        var cName = document.getElementById("cName2").value;
        var cTaxCode = document.getElementById("cTaxCode2").value;
        var cEmail = document.getElementById("cEmail2").value;
        var cPhone = document.getElementById("cPhone2").value.replace(/\D/g, '');
        var cAddress = document.getElementById("cAddress2").value;
        var cType = document.getElementById("cType2").value;
       
        
        var aEmail = document.getElementById("aEmail2").value;
        var aName = document.getElementById("aName2").value;
        var aPhone = document.getElementById("aPhone2").value.replace(/\D/g, '');
        var aStatus = document.getElementById("aStatus2").value;
        var aDate = document.getElementById("aDate2").value;
        var aGender = document.getElementById("aGender2").value;
  
        var cValues = {
            CustomerId: cID || "AUTO_GENERATED_ID",
            CompanyName: cName,
            TaxCode: cTaxCode,
            CompanyAccount: cEmail,
            AccountIssuedDate: new Date().toISOString(),
            CPhoneNumber: cPhone,
            CAddress: cAddress,
            CustomerType: cType.toLowerCase() === "vip",
            ContractNumber: "",
            ServiceType: "", // Lưu tên hiển thị thay vì ID

            RootAccount: aEmail,
            RootName: aName,
            RPhoneNumber: aPhone,
            OperatingStatus: aStatus.trim() === "1",
            DateOfBirth: aDate ? new Date(aDate).toISOString() : null,
            Gender: aGender === "nu",
            Startdate: null,
            Enddate: null,
            Amount: 0
        };
        return cValues;
    }


    function SaveAccount() {
        var cId = document.getElementById("cId").value.trim();
        var cId2 = document.getElementById("cId2").value.trim();
        console.log("Gia tri cId la: ", cId);
        console.log("Gia tri cId2 la: ", cId2);
        if (cId === "" && cId2 !== "") {

            cValues = getID2(cId2);
            console.log("Gia tri cValues2  la: ", cValues);

            if (!cValues.CompanyName || !cValues.TaxCode || !cValues.CompanyAccount || !cValues.CPhoneNumber || !cValues.CAddress || !cValues.RootAccount || !cValues.RootName || !cValues.RPhoneNumber ) {

                showError("Vui lòng nhập đầy đủ thông tin.");

                return;
            }
        }
        else {
            cValues = getID1(cId);
            console.log("Gia tri cValues  la: ", cValues);

            var startDate = new Date(cValues.Startdate);
            var endDate = new Date(cValues.EndDate);
            if (startDate >= endDate) {
                showError("Kiểm tra lại ngày tháng của hợp đồng: Ngày bắt đầu phải nhỏ hơn ngày kết thúc.");
                return;
            }
            if (!cValues.CompanyName || !cValues.TaxCode || !cValues.CompanyAccount || !cValues.CPhoneNumber || !cValues.CAddress || !cValues.RootAccount || !cValues.RootName || !cValues.RPhoneNumber || !cValues.Amount) {

                showError("Vui lòng nhập đầy đủ thông tin.");
                return;
            }

        }
        console.log("Gia tri la: ",cValues); 
       
        
        var phoneRegex = /^(0\d{9,10})$/; // Số điện thoại bắt đầu bằng số 0, có 10 hoặc 11 chữ số
        // Biểu thức chính quy kiểm tra email hợp lệ
        var emailRegex = @Html.Raw("/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/");

        // Kiểm tra mã số thuế (9 chữ số)
        var taxCodeRegex = /^[a-zA-Z0-9]{9}$/;

        // Kiểm tra độ dài ContractNumber (tối đa 10 ký tự)
       
        if (!phoneRegex.test(cValues.CPhoneNumber)) {
            showError("Số điện thoại khách hàng không hợp lệ. Phải có 10 chữ số và bắt đầu bằng 0.");
            return;
        }

        if (!phoneRegex.test(cValues.RPhoneNumber)) {
            showError("Số điện thoại người đại diện không hợp lệ. Phải có 10 chữ số và bắt đầu bằng 0.");
            return;
        }

        // Kiểm tra định dạng email
        if (!emailRegex.test(cValues.CompanyAccount)) {
            showError("Email khách hàng không hợp lệ.");
            return;
        }

        if (!emailRegex.test(cValues.RootAccount)) {
            showError("Email người đại diện không hợp lệ.");
            return;
        }

        // Kiểm tra mã số thuế
        if (!taxCodeRegex.test(cValues.TaxCode)) {
            showError("Mã số thuế không hợp lệ. Phải có đúng 9 kí tự.");
            return;
        }

        var StaffId = "@User.FindFirst("StaffId")?.Value";

        // Xác định Insert hay Update
        var isUpdate = cValues.CustomerId && cValues.CustomerId !== "AUTO_GENERATED_ID";
        var url = isUpdate ? `/admin/account/Update?id=${StaffId}` : `/admin/account/Insert?id=${StaffId}`;
        var confirmText = isUpdate ? "Bạn có chắc muốn cập nhật tài khoản không?" : "Bạn có chắc muốn thêm tài khoản không?";

        document.getElementById("contentModalConfirm").innerHTML = confirmText;
        const modal = new bootstrap.Modal(document.getElementById("confirmModal"));
        modal.show();

        $("#confirmButton1").off("click").on("click", function () {
            modal.hide();
            $.ajax({
                url: url,
                type: 'POST',
                headers: {
                    "Authorization": "Bearer " + tokenJWT
                },
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: JSON.stringify(cValues),
                success: function (response) {
                    if (response.success) {
                        document.getElementById("contentModalSuccess").innerHTML = isUpdate ? "Cập nhật tài khoản thành công" : "Thêm tài khoản thành công";
                        $("#ModalSuccess").modal("show");
                        refresh();
                        var keyword = $('input[type="text"]').val();
                        var category = $('select').val();
                        init(keyword, category);
                        // Gọi sự kiện "Quay lại" để trở về danh sách
                        if (isUpdate)
                        {
                            backBtn2.click();
                        }
                        else
                        backBtn.click();
                    }
                },
                error: function (xhr) {
                    let errorMessage = "Lỗi không xác định.";
                    if (xhr.responseJSON) {
                        if (Array.isArray(xhr.responseJSON.message) && xhr.responseJSON.message.length > 0) {
                            errorMessage = xhr.responseJSON.message.join("<br>");
                        } else if (typeof xhr.responseJSON.message === "string" && xhr.responseJSON.message.length > 0) {
                            errorMessage = xhr.responseJSON.message;
                        }
                    }
                    $("#contentModalError").html(errorMessage);
                    $("#ModalError").modal("show");
                    // Gán sự kiện đóng modal vào nút "Đóng"
                    document.getElementById("btnCloseModal").addEventListener("click", function () {
                        $("#ModalError").modal("hide");
                    });
                }
            });
        });
    }

    function refresh() {
        document.getElementById("cId").value = "";
        document.getElementById("cName").value = "";
        document.getElementById("cTaxCode").value = "";
        document.getElementById("cEmail").value = "";
        document.getElementById("cPhone").value = "";
        document.getElementById("cAddress").value = "";
        document.getElementById("cType").value = "normal";
        document.getElementById("serviceType").value = "doi-tac";
        document.getElementById("ContractNumber").value = "";
        document.getElementById("aEmail").value = "";
       // document.getElementById("aNameID").value = "";
        document.getElementById("aName").value = "";
        document.getElementById("aPhone").value = "";
        document.getElementById("aDate").value = "";
        document.getElementById("startDate").value = "";
        document.getElementById("endDate").value = "";
        document.getElementById("aGender").value = "nam";
        document.getElementById("aStatus").value = "1";
        document.getElementById("timeGiahan").value = "";
        document.getElementById("amount").value = "";

        document.getElementById("cId2").value = "";
        document.getElementById("cName2").value = "";
        document.getElementById("cTaxCode2").value = "";
        document.getElementById("cEmail2").value = "";
        document.getElementById("cPhone2").value = "";
        document.getElementById("cAddress2").value = "";
        document.getElementById("cType2").value = "normal";
       // document.getElementById("serviceType2").value = "doi-tac";
       // document.getElementById("ContractNumber2").value = "";
        document.getElementById("aEmail2").value = "";
        document.getElementById("aNameID2").value = "";
        document.getElementById("aName2").value = "";
        document.getElementById("aPhone2").value = "";
        document.getElementById("aDate2").value = "";
        document.getElementById("accountIssuedDate").value = "";

        document.getElementById("aGender2").value = "nam";
        document.getElementById("aStatus2").value = "1";
        //document.getElementById("startDate2").value = "";
       
       //  document.getElementById("endDate2").value = "";
      //  document.getElementById("amount2").value = "";

    }

    function showError(message) {
        document.getElementById("contentModalError").innerText = message;

        // Khởi tạo modal bằng Bootstrap 5
        var errorModal = new bootstrap.Modal(document.getElementById("ModalError"), {
            keyboard: true, // Cho phép bấm phím ESC để đóng
            backdrop: 'static' // Không đóng modal khi bấm ngoài
        });
        // Hiển thị modal
        errorModal.show();
        // Gán sự kiện đóng modal vào nút "Đóng"
        document.getElementById("btnCloseModal").addEventListener("click", function () {
            errorModal.hide();
        });
    }

    // function exportToCsv(event) {
    //     event.preventDefault(); // Ngăn chặn load lại trang nếu là <button>
    //     console.log("Gọi exportToCsv()"); // Kiểm tra xem hàm có được gọi không
    //     var keyword = $('input[type="text"]').val();
    //     var categoryText = $('select').val();
    //     // Chuyển đổi giá trị của select


    //     $.ajax({
    //         url: "/Admin/Account/ExportToCsv",
    //         type: "POST",
    //         contentType: "application/json",
    //         data: JSON.stringify({ Keyword: keyword, Category: categoryText }),
    //         success: function (res) {
    //             console.log("Response từ server:", res); // Debug response

    //             if (res.success && res.fileUrl) {
    //                 let fileUrl = res.fileUrl;

    //                 $("#contentModalSuccess").html(`
    //                         <strong>Xuất file thành công!</strong> <br>
    //                         <a href="${fileUrl}" download>📥 Tải xuống CSV</a>
    //                         <br>
    //                         <button type="button" class="btn btn-secondary mt-3" data-dismiss="modal">Đóng</button>
    //                     `);

    //                 $("#ModalSuccess").modal("show"); // Hiển thị modal
    //             } else {
    //                 //alert("Xuất file thất bại!");
    //                 showError("Xuất file thất bại!");

    //             }
    //         },
    //         error: function (xhr) {
    //             console.error("Lỗi Ajax:", xhr.responseText);
    //             showError("Xuất file thất bại!");

    //             //alert("Xuất file thất bại!");
    //         }
    //     });
    // }

    function exportToCsv(event) {
        event.preventDefault();
        console.log("Gọi exportToCsv()");

        var keyword = $('input[type="text"]').val();
        var categoryText = $('select').val();

        $.ajax({
            url: "/Admin/Account/ExportToCsv",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ Keyword: keyword, Category: categoryText }),
            xhrFields: {
                responseType: 'blob' // ✅ Nhận phản hồi dạng file blob
            },
            success: function (blob, status, xhr) {
                var filename = "DanhSachKhachHang.csv";

                var link = document.createElement("a");
                link.href = window.URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                $("#contentModalSuccess").html(`
                    <strong>Xuất file thành công!</strong> <br>
                    📥 File đang được tải xuống tự động!
                `);
                $("#ModalSuccess").modal("show");
            },
            error: function (xhr) {
                console.error("Lỗi Ajax:", xhr.responseText);
                showError("Xuất file thất bại!");
            }
        });
    }

   
</script>
